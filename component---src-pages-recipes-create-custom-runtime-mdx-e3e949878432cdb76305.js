"use strict";(self.webpackChunkelyra_ai_site=self.webpackChunkelyra_ai_site||[]).push([[7285],{2941:function(e,t,a){a.r(t),a.d(t,{Title:function(){return s},_frontmatter:function(){return c},default:function(){return u}});var n,i=a(3366),r=(a(7294),a(4983)),o=a(4295),l=["components"],s=function(){return(0,r.kt)("span",null,"Creating a custom runtime container image")},c={},p=(n="PageDescription",function(e){return console.warn("Component "+n+" was not imported, exported, or provided by MDXProvider as global scope"),(0,r.kt)("div",e)}),m={Title:s,_frontmatter:c},d=o.Z;function u(e){var t=e.components,a=(0,i.Z)(e,l);return(0,r.kt)(d,Object.assign({},m,a,{components:t,mdxType:"MDXLayout"}),(0,r.kt)(p,{mdxType:"PageDescription"},(0,r.kt)("p",null,"A runtime image provides the execution environment in which nodes are executed when a Jupyter notebook is processed as part of a pipeline. Elyra includes a number of runtime images for popular configurations, such as TensorFlow or Pytorch.")),(0,r.kt)("p",null,"Should none of these images meet your needs, you can utilize a custom container image, as long as it meets the following pre-requisites:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"The image is stored in a container registry in a public or private network that the container platform in which the pipeline is executed can connect to. Examples of such registries are ",(0,r.kt)("a",{parentName:"li",href:"https://hub.docker.com"},"hub.docker.com")," or a self-managed registry in an intranet environment."),(0,r.kt)("li",{parentName:"ul"},"The image can be pulled from the registry without the need to authenticate. "),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://www.python.org/"},"Python 3")," is pre-installed and in the search path. Python versions that have reached their “end of life” are not supported."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://curl.haxx.se/"},(0,r.kt)("inlineCode",{parentName:"a"},"curl"))," is pre-installed and in the search path.")),(0,r.kt)("p",null,"Refer to the ",(0,r.kt)("a",{parentName:"p",href:"#additional-considerations"},"Additional considerations")," section for important implementation details."),(0,r.kt)("h2",null,"Requirements"),(0,r.kt)("p",null,"To create a custom container image and publish it on ",(0,r.kt)("a",{parentName:"p",href:"https://hub.docker.com"},"hub.docker.com")," you need"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Docker Desktop",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"Available for ",(0,r.kt)("a",{parentName:"li",href:"https://hub.docker.com/editions/community/docker-ce-desktop-mac"},"MacOS")," and\n",(0,r.kt)("a",{parentName:"li",href:"https://hub.docker.com/editions/community/docker-ce-desktop-windows"},"Windows")))),(0,r.kt)("li",{parentName:"ul"},"A Docker id at ",(0,r.kt)("a",{parentName:"li",href:"https://hub.docker.com"},"https://hub.docker.com/"),".")),(0,r.kt)("h2",null,"Creating a basic Python runtime container image"),(0,r.kt)("p",null,"The ",(0,r.kt)("a",{parentName:"p",href:"https://hub.docker.com/_/python"},"default Python 3 Docker image")," has Python and ",(0,r.kt)("inlineCode",{parentName:"p"},"curl")," pre-installed and it is therefore a good starting point."),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Create a file named ",(0,r.kt)("inlineCode",{parentName:"p"},"Dockerfile")," and add the following content."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},"FROM python:3\n\nCOPY requirements.txt ./\nRUN pip3 install --no-cache-dir -r requirements.txt\n")),(0,r.kt)("p",{parentName:"li"},"When you create a container image using this ",(0,r.kt)("inlineCode",{parentName:"p"},"Dockerfile")," the ",(0,r.kt)("a",{parentName:"p",href:"https://hub.docker.com/_/python"},"default Python 3 Docker image")," is loaded and the requirements listed in ",(0,r.kt)("inlineCode",{parentName:"p"},"requirements.txt")," ",(0,r.kt)("inlineCode",{parentName:"p"},"pip"),"-installed.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"in the same directory create a ",(0,r.kt)("inlineCode",{parentName:"p"},"requirements.txt")," file and add the packages your notebooks depend on. For example, if your notebooks require the latest version of ",(0,r.kt)("inlineCode",{parentName:"p"},"Pandas")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"Numpy"),",  add the appropriate package names."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},"pandas\nnumpy\n")),(0,r.kt)("p",{parentName:"li"},"Note: If your notebooks require packages that are not pre-installed on this image they need to ",(0,r.kt)("inlineCode",{parentName:"p"},"pip"),"-install them explicitly.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Open a terminal to the location where you’ve created the ",(0,r.kt)("inlineCode",{parentName:"p"},"Dockerfile")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"requirements.txt"),"."))),(0,r.kt)("h2",null,"Using Docker"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Build the container image by running the ",(0,r.kt)("a",{parentName:"p",href:"https://docs.docker.com/engine/reference/commandline/build/"},(0,r.kt)("inlineCode",{parentName:"a"},"docker build"))," command in the terminal window, replacing ",(0,r.kt)("inlineCode",{parentName:"p"},"my-runtime-image")," with the desired Docker image name."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"docker build -t my-runtime-image .\n")))),(0,r.kt)("h2",null,"Publishing the basic runtime container image"),(0,r.kt)("p",null,"When a notebook is processed as part of a pipeline the associated container image is downloaded from the container registry stated in the URL of the image."),(0,r.kt)("p",null,"For example, the following steps publish the container image you’ve just created on ",(0,r.kt)("a",{parentName:"p",href:"https://hub.docker.com"},"Docker Hub")," using docker."),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Log in to Docker Hub using ",(0,r.kt)("a",{parentName:"p",href:"https://docs.docker.com/engine/reference/commandline/login/"},(0,r.kt)("inlineCode",{parentName:"a"},"docker login"))," and provide your Docker id and password."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"docker login\n"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Run ",(0,r.kt)("a",{parentName:"p",href:"https://docs.docker.com/engine/reference/commandline/images/"},(0,r.kt)("inlineCode",{parentName:"a"},"docker images"))," and locate the image id for your Docker image. The image id uniquely identifies your Docker image."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"docker images\n\nREPOSITORY         TAG      IMAGE ID            CREATED             SIZE \nmy-runtime-image   latest   0d1bd98fdd84        2 hours ago         887MB\n"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Tag the container image using ",(0,r.kt)("a",{parentName:"p",href:"https://docs.docker.com/engine/reference/commandline/tag/"},(0,r.kt)("inlineCode",{parentName:"a"},"docker tag")),", replacing ",(0,r.kt)("inlineCode",{parentName:"p"},"my-image-id"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"docker-id-or-org-id"),", and ",(0,r.kt)("inlineCode",{parentName:"p"},"my-runtime-image")," as necessary. (",(0,r.kt)("inlineCode",{parentName:"p"},"docker-id-or-org-id")," is either your Docker id or, if you are a member of a team in an organization, the id of that organization.)"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"docker tag my-image-id docker-id-or-org-id/my-runtime-image:latest\n")),(0,r.kt)("p",{parentName:"li"},"Note: For illustrative purposes this image is tagged ",(0,r.kt)("inlineCode",{parentName:"p"},"latest"),", which makes it the default image. If desired, replace the tag with a specific version number or identifier, such as ",(0,r.kt)("inlineCode",{parentName:"p"},"Vx.y.z"),".")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Publish the container image on Docker Hub by running ",(0,r.kt)("a",{parentName:"p",href:"https://docs.docker.com/engine/reference/commandline/push/"},(0,r.kt)("inlineCode",{parentName:"a"},"docker push")),", replacing ",(0,r.kt)("inlineCode",{parentName:"p"},"docker-id-or-org-id")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"my-runtime-image")," as necessary."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"docker push docker-id-or-org-id/my-runtime-image:latest\n")))),(0,r.kt)("p",null,"Once the image is published on Docker Hub you can ",(0,r.kt)("a",{parentName:"p",href:"/elyra-ai-site/user_guide/runtime-image-conf.md"},"create a runtime image configuration using the Elyra UI or ",(0,r.kt)("inlineCode",{parentName:"a"},"elyra-metadata")," CLI")," and reference the published ",(0,r.kt)("inlineCode",{parentName:"p"},"docker-id-or-org-id/my-runtime-image:latest")," Docker image."),(0,r.kt)("h2",null,"Additional Considerations"),(0,r.kt)("p",null,"Prior to notebook processing Elyra modifies the associated container by changing the default execution command and installing additional packages.\nPlease review the following section if"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"your Dockerfile ",(0,r.kt)("a",{parentName:"li",href:"#dockerfiles-with-cmd-instructions"},"includes a CMD instruction")),(0,r.kt)("li",{parentName:"ul"},"your Dockerfile ",(0,r.kt)("a",{parentName:"li",href:"#dockerfiles-with-entrypoint-instructions"},"includes an ENTRYPOINT instruction")),(0,r.kt)("li",{parentName:"ul"},"your package requirements ",(0,r.kt)("a",{parentName:"li",href:"#conflicting-package-dependencies"},"include pinned versions"))),(0,r.kt)("h3",null,"Dockerfiles with CMD instructions"),(0,r.kt)("p",null,"If a ",(0,r.kt)("inlineCode",{parentName:"p"},"Dockerfile")," includes a ",(0,r.kt)("a",{parentName:"p",href:"https://docs.docker.com/engine/reference/builder/#cmd"},(0,r.kt)("inlineCode",{parentName:"a"},"CMD"))," instruction, which is used to specify defaults for an executing container, you might have to customize your notebooks. When a notebook is processed as part of a pipeline the ",(0,r.kt)("inlineCode",{parentName:"p"},"CMD")," instruction is overriden, which might have side effects. The following examples illustrate two scenarios."),(0,r.kt)("h4",null,"Scenario 1 - override has no side-effects"),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"CMD")," instruction launches an application that does not need to be running when the notebook is executed. For example, the official Python container images might launch the interactive Python shell by default, like so:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'...\nCMD ["python3"]\n')),(0,r.kt)("p",null,"Notebooks will work as is because Python is explicitly run during notebook processing."),(0,r.kt)("h4",null,"Scenario 2 - override has side-effects"),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"CMD")," instruction launches an application or service that a notebook consumes. For example, a container image might by default launch an application that provides computational (or connectivity) services that notebooks rely on."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'...\nCMD ["python3", "/path/to/application-or-service"]\n')),(0,r.kt)("p",null,"When the container started to process a notebook, the referenced application is unavailable because it wasn’t automatically started. If feasible, the notebook could launch the application in the background in a code cell like so:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},'import os\nimport time\n# launch application in the background\nos.system("python /path/to/application-or-service &")\n# wait to allow for application initialization\ntime.sleep(2)\n')),(0,r.kt)("h3",null,"Dockerfiles with ENTRYPOINT instructions"),(0,r.kt)("p",null,"If a container is configured to run as an executable by using the  ",(0,r.kt)("a",{parentName:"p",href:"https://docs.docker.com/engine/reference/builder/#entrypoint"},(0,r.kt)("inlineCode",{parentName:"a"},"ENTRYPOINT"))," instruction in the ",(0,r.kt)("inlineCode",{parentName:"p"},"Dockerfile"),", you likely have to customize your notebook. "),(0,r.kt)("h4",null,"Scenario 1 - override has side-effects"),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"ENTRYPOINT")," instruction launches an application or service that a notebook consumes."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'ENTRYPOINT ["python3", "/path/to/application-or-service"]\n')),(0,r.kt)("p",null,"When the container is launched to process a notebook the application or service is unavailable because it wasn’t automatically started. If feasible, the notebook could launch the application or service in the background in a code cell like so:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},'import os\nimport time\n# launch application in the background\nos.system("python /path/to/application-or-service &")\n# wait to allow for application initialization\ntime.sleep(2)\n')),(0,r.kt)("h3",null,"Conflicting package dependencies"),(0,r.kt)("p",null,"Elyra installs additional packages in the container prior to notebook processing. If a pre-installed package is not compatible with the version requirements defined in ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/elyra-ai/elyra/blob/main/etc/generic/requirements-elyra.txt"},"requirements-elyra.txt"),", it is replaced. You should review any version discrepancies as they might lead to unexpected processing results."))}u.isMDXComponent=!0},4295:function(e,t,a){a.d(t,{Z:function(){return v}});var n=a(7294),i=a(8650),r=a.n(i),o=a(5444),l=a(9403),s=a(5611),c=a(5900),p=a.n(c),m=function(e){var t,a=e.title,i=e.theme,r=e.tabs,o=void 0===r?[]:r;return n.createElement("div",{className:p()("PageHeader-module--page-header--NqfPe",(t={},t["PageHeader-module--with-tabs--vbQ-W"]=o.length,t["PageHeader-module--dark-mode--WCeH8"]="dark"===i,t))},n.createElement("div",{className:"bx--grid"},n.createElement("div",{className:"bx--row"},n.createElement("div",{className:"bx--col-lg-12"},n.createElement("h1",{id:"page-title",className:"PageHeader-module--text--Er2EO"},a)))))},d=function(e){var t=e.relativePagePath,a=e.repository,i=(0,o.useStaticQuery)("1364590287").site.siteMetadata.repository,r=a||i,l=r.baseUrl,s=r.subDirectory,c=l+"/edit/"+r.branch+s+"/src/pages"+t;return l?n.createElement("div",{className:"bx--row EditLink-module--row--BEmSX"},n.createElement("div",{className:"bx--col"},n.createElement("a",{className:"EditLink-module--link--IDrl1",href:c},"Edit this page on GitHub"))):null},u=a(4275),h=a(1721),k=function(e){function t(){return e.apply(this,arguments)||this}return(0,h.Z)(t,e),t.prototype.render=function(){var e=this.props,t=e.title,a=e.tabs,i=e.slug,l=i.split("/").filter(Boolean).slice(-1)[0],s=a.map((function(e){var t,a=r()(e,{lower:!0,strict:!0}),s=a===l,c=new RegExp(l+"/?(#.*)?$"),m=i.replace(c,a);return n.createElement("li",{key:e,className:p()((t={},t["PageTabs-module--selected-item--aBB0K"]=s,t),"PageTabs-module--list-item--024o6")},n.createElement(o.Link,{className:"PageTabs-module--link--Kz-7R",to:""+m},e))}));return n.createElement("div",{className:"PageTabs-module--tabs-container--Cdfzw"},n.createElement("div",{className:"bx--grid"},n.createElement("div",{className:"bx--row"},n.createElement("div",{className:"bx--col-lg-12 bx--col-no-gutter"},n.createElement("nav",{"aria-label":t},n.createElement("ul",{className:"PageTabs-module--list--xLqxG"},s))))))},t}(n.Component),g=k,N=a(2881),f=a(6958),b=a(36),y=function(e){var t=e.date,a=new Date(t);return t?n.createElement(b.X2,{className:"last-modified-date-module--row--XJoYQ"},n.createElement(b.sg,null,n.createElement("div",{className:"last-modified-date-module--text--ogPQF"},"Page last updated: ",a.toLocaleDateString("en-GB",{day:"2-digit",year:"numeric",month:"long"})))):null},v=function(e){var t=e.pageContext,a=e.children,i=e.location,c=e.Title,p=t.frontmatter,h=void 0===p?{}:p,k=t.relativePagePath,b=t.titleType,v=h.tabs,w=h.title,C=h.theme,E=h.description,x=h.keywords,D=h.date,P=(0,f.Z)().interiorTheme,T=(0,o.useStaticQuery)("2456312558").site.pathPrefix,I=T?i.pathname.replace(T,""):i.pathname,q=v?I.split("/").filter(Boolean).slice(-1)[0]||r()(v[0],{lower:!0}):"",M=C||P;return n.createElement(s.Z,{tabs:v,homepage:!1,theme:M,pageTitle:w,pageDescription:E,pageKeywords:x,titleType:b},n.createElement(m,{title:c?n.createElement(c,null):w,label:"label",tabs:v,theme:M}),v&&n.createElement(g,{title:w,slug:I,tabs:v,currentTab:q}),n.createElement(N.Z,{padded:!0},a,n.createElement(d,{relativePagePath:k}),n.createElement(y,{date:D})),n.createElement(u.Z,{pageContext:t,location:i,slug:I,tabs:v,currentTab:q}),n.createElement(l.Z,null))}}}]);
//# sourceMappingURL=component---src-pages-recipes-create-custom-runtime-mdx-e3e949878432cdb76305.js.map